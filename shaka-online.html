<html>
<head>
<title>Shaka test - online play #3</title>
<script src="https://ajax.googleapis.com/ajax/libs/shaka-player/4.5.0/shaka-player.compiled.js"></script>
<script>
async function init(serverURL) {
  const video = document.getElementById('videoPlayer');
  const player = new shaka.Player();
  await player.attach(video);
  
  player.configure({
    drm: {
      servers: { 'com.widevine.alpha': serverURL }
    }
  });

  // Try to load a manifest.
  try {
    await player.load('https://video.gumlet.io/655243edfc21dc1b6b763c4c/6554c7a03699cbd2c01f0b68/main.mpd');
    // The video should now be playing!  
  } catch (error) {
    console.error('Error code', error.code, 'object', error);
  }
}

function check() {
    if (location.protocol === 'http:' && location.hostname !== 'localhost') {
        var out = 'This page has been loaded under http. This might result in the EME APIs not being available to the player and any DRM-protected content will fail to play. ' +
            'If you wish to test manifest URLs that require EME support, then <a href=\'https:' + window.location.href.substring(window.location.protocol.length) + '\'>reload this page under https</a>.'
        var div = document.getElementById('http-warning');
        div.innerHTML = out;
        div.style.display = ''
    }
}

async function fetchAndGo() {
  shaka.polyfill.installAll();

  if (shaka.Player.isBrowserSupported()) {
    console.info('Browser supported!');
    const response = await fetch('https://worker-white-moon-c279.gilles-7b1.workers.dev/');
    const serverURL = await response.text();
    check();
    await init(serverURL.trim());
  } else {
    console.error('Browser not supported!');
  }
}
</script>
</head>
<body>
  <video id="videoPlayer" controls muted autoplay></video>
  <script>
      document.addEventListener('DOMContentLoaded', fetchAndGo);
  </script>
</body>
</html>
